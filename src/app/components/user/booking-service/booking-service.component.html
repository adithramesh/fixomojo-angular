<app-nav-bar></app-nav-bar>
<br />
<div class="booking-container">
  <!-- Left Panel -->
  <div class="booking-left">
    <!-- Steps Navigation -->
    <div class="booking-steps">
      <div class="steps-header">
        <h2>Book a Service</h2>
      </div>

      <div class="steps-list">
        <button
          *ngFor="let step of [1, 2, 3, 4]"
          type="button"
          class="step-item"
          [class.active]="isStepActive(step)"
          [class.completed]="isStepCompleted(step)"
          [class.clickable]="canNavigateToStep(step)"
          (click)="goToStep(step)"
        >
          <div class="step-indicator">
            <span *ngIf="!isStepCompleted(step)">{{ step }}</span>
            <span *ngIf="isStepCompleted(step)">‚úì</span>
          </div>
          <div class="step-content">
            <h3 class="step-title">{{ getStepTitle(step) }}</h3>
          </div>
        </button>
      </div>
    </div>

    <!-- Step Content -->
    <div class="booking-content">
      <!-- Step 1: Location -->
      <section *ngIf="currentStep === 1" class="step-panel">
        <header class="panel-header">
          <h3>Choose Your Location</h3>
          <p>Select your service location or enter address</p>
        </header>
        <div class="location-content">

        
        <div class="form-group">
          <label for="address-input">Address:</label>
          <input
            id="address-input"
            type="text"
            class="form-input"
            [(ngModel)]="addressInput"
            (input)="onAddressInputChange(addressInput)"
            placeholder="Start typing a full address..."
          />

          <ul *ngIf="autocompleteSuggestions.length > 0" class="autocomplete-suggestions">
            <li
              *ngFor="let suggestion of autocompleteSuggestions"
              role="button"
              tabindex="0"
              (click)="onSelectSuggestion(suggestion)"
              (keyup.enter)="onSelectSuggestion(suggestion)"
              (keyup.space)="onSelectSuggestion(suggestion)"
            >
              {{ suggestion.display_name }}
            </li>
          </ul>

          <p *ngIf="selectedAddressDetails" class="location-info">
            <strong>Selected Address:</strong> {{ selectedAddressDetails.address }}
          </p>
          <p *ngIf="typedLocationErrorMessage" class="error-message">
            {{ typedLocationErrorMessage }}
          </p>
        </div>
    </div>
        <div class="location-actions">
          <button type="button" class="secondary-button" (click)="getCurrentLocation()">
            üìç Use Current Location
          </button>
        </div>
      </section>

      <!-- Step 2: Technician -->
      <section *ngIf="currentStep === 2" class="step-panel">
        <header class="panel-header">
          <h3>Choose Your Technician</h3>
          <p>Available technicians within 10km radius</p>
        </header>
<div class="technician-content">
        <ng-container *ngIf="!isLoadingTechnicians; else loadingTechs">
          <p *ngIf="availableTechnicians.length === 0">No technicians available for the selected location.</p>

          <div class="technician-list" *ngIf="availableTechnicians.length > 0">
            <button
              *ngFor="let technician of availableTechnicians"
              type="button"
              class="technician-card"
              [class.selected]="bookingForm.get('technician')?.value === technician.id"
              (click)="onTechnicianSelected(technician)"
            >
              <div class="technician-avatar">
                <img [src]="technician.profileImage" [alt]="technician.name" />
              </div>
              <div class="technician-info">
                <h4>{{ technician.name }}</h4>
                <p>‚≠ê {{ technician.rating }} | {{ technician.experience }}</p>
                <p>üìç {{ technician.distance }} km away</p>
              </div>
              <span *ngIf="bookingForm.get('technician')?.value === technician.id">‚úì</span>
            </button>
          </div>
         
        </ng-container>
</div>
        <ng-template #loadingTechs>
          <p>Finding available technicians...</p>
        </ng-template>
      </section>

      <!-- Step 3: Date & Time -->
      <section *ngIf="currentStep === 3" class="step-panel">
        <header class="panel-header">
          <h3>Select Date & Time Slot</h3>
          <p>Choose a convenient date and time</p>
        </header>
<div class="timeslot-content">
        <div>
          <label for="service-date">Select Date:</label>
          <input
            id="service-date"
            type="date"
            [(ngModel)]="selectedDate"
            [min]="minDate"
            [max]="maxDate"
            (change)="onDateSelected()"
          />
        </div>

        <div *ngIf="selectedDate">
          <ng-container *ngIf="!isLoadingTimeSlots; else loadingSlots">
            <p *ngIf="availableTimeSlots.length === 0">No available slots for this date.</p>

            <div class="timeslot-grid" *ngIf="availableTimeSlots.length > 0">
              <button
                *ngFor="let slot of availableTimeSlots"
                type="button"
                class="timeslot-item"
                [class.selected]="bookingForm.get('timeSlot')?.value === slot.id"
                (click)="onTimeSlotSelected(slot)"
              >
                {{ slot.time }}
              </button>
            </div>
          </ng-container>

          <ng-template #loadingSlots>
            <p>Loading available time slots...</p>
          </ng-template>
        </div>

        </div>
      </section>

      <!-- Step 4: Payment -->
      <section *ngIf="currentStep === 4" class="step-panel">
        <header class="panel-header">
          <h3>Payment & Confirmation</h3>
          <p>Review your booking and pay</p>
        </header>
<div class="payment-content">
        <div class="booking-summary">
          <h4>Booking Summary</h4>
          <p><strong>Service:</strong> {{ subServiceName }}</p>
          <p><strong>Location:</strong> {{ userLocation.address || 'Not selected' }}</p>
          <p><strong>Time:</strong> {{ getSelectedTimeSlot()?.time || 'Not selected' }}</p>
          <p><strong>Technician:</strong> {{ getSelectedTechnician()?.name || 'Not selected' }}</p>
          <p><strong>Price:</strong> {{ price }}</p>
          <p *ngIf="appliedDiscount > 0"><strong>Offer ({{ appliedOfferName }}):</strong> -{{ appliedDiscount }}</p>
          <p><strong>Amount Payable:</strong> {{ finalAmount }}</p>
        </div>

        <div class="payment-options">
          <button
            type="button"
            class="payment-option"
            [class.selected]="bookingForm.get('paymentMethod')?.value === 'Card'"
            (click)="onPaymentMethodSelected('Card')"
          >
            üí≥ Card
          </button>
          <button
            type="button"
            class="payment-option"
            [class.selected]="bookingForm.get('paymentMethod')?.value === 'Wallet'"
            (click)="onPaymentMethodSelected('Wallet')"
          >
            üëõ Wallet
          </button>
          <button
            type="button"
            class="payment-option"
            [class.selected]="bookingForm.get('paymentMethod')?.value === 'Cash'"
            (click)="onPaymentMethodSelected('Cash')"
          >
            üí∞ Cash
          </button>
        </div>
       </div> 
      </section>
    </div>

    <!-- Navigation -->
    <div class="step-navigation">
      <button *ngIf="currentStep > 1" type="button" class="secondary-button" (click)="previousStep()">
        Previous
      </button>
      <button
        *ngIf="currentStep < maxSteps"
        type="button"
        class="signup-button"
        [disabled]="!canProceedToNextStep()"
        (click)="nextStep()"
      >
        Next
      </button>
      <button
        *ngIf="currentStep === maxSteps"
        type="button"
        class="signup-button"
        [disabled]="!canProceedToNextStep()"
        (click)="onSubmit()"
      >
        Pay Now
      </button>
    </div>
  </div>

  <!-- Right Panel -->
  <aside class="booking-right">
    <div class="map-container">
      <h3>Location</h3>
      <div *ngIf="isLoadingMap">Loading map...</div>
      <div *ngIf="!isLoadingMap">
        üó∫Ô∏è Map placeholder
        <p *ngIf="userLocation">üìç {{ userLocation.address }}</p>
        <p *ngIf="getSelectedTechnician()">
          Technician: {{ getSelectedTechnician()!.name }} ({{ getSelectedTechnician()!.distance }} km)
        </p>
      </div>
    </div>

    <div *ngIf="currentStep >= 2">
      <h3>Available Technicians</h3>
      <div *ngIf="isLoadingTechnicians">Loading technicians...</div>
      <p *ngIf="!isLoadingTechnicians && availableTechnicians.length === 0">No technicians available within 10km.</p>
      <ul *ngIf="!isLoadingTechnicians && availableTechnicians.length > 0">
        <li *ngFor="let tech of availableTechnicians" [class.selected]="bookingForm.get('technician')?.value === tech.id">
          <strong>{{ tech.name }}</strong> ‚≠ê {{ tech.rating }} ({{ tech.distance }} km away)
        </li>
      </ul>
    </div>

    <div *ngIf="currentStep >= 3">
      <h3>Available Time Slots</h3>
      <p *ngIf="!selectedDate">Please select a date first</p>
      <p *ngIf="selectedDate && isLoadingTimeSlots">Loading time slots...</p>
      <p *ngIf="selectedDate && !isLoadingTimeSlots && availableTimeSlots.length === 0">
        No slots for selected date
      </p>
      <ul *ngIf="selectedDate && !isLoadingTimeSlots && availableTimeSlots.length > 0">
        <li *ngFor="let slot of availableTimeSlots" [class.selected]="bookingForm.get('timeSlot')?.value === slot.id">
          {{ slot.time }}
          <span *ngIf="bookingForm.get('timeSlot')?.value === slot.id">‚úì Selected</span>
        </li>
      </ul>
    </div>
  </aside>
</div>
